# Z80 instruction executor for x86

x86系CPUでZ80機械語を解釈して実行するモジュールです。  

本モジュールは CP/M-80 2.2用のプログラムを  
MS-DOS上で実行する CP/M Player for generic MS-DOS の  
Z80コードエミュレーションモジュールとして開発しました。  

当初は8080コードのみ対応でしたが、Hi-tech C 等で作成された  
Z80コードを含むプログラムを動作させるためZ80命令に対応しました。  

出来上がった Z80EM.BINはOSに依存しないため  
MS-DOS CP/M-86 DR-DOS ベアメタル いずれでも使えます。  

Z80の未定義命令対応は中途半端です。  
一部HD64180の乗算命令とIX,IYの8ビット分割命令に対応した程度です。  
また、減算フラグとオーバーフローフラグの実装は細部が再現できていません。  

## ビルド環境

OS：MS-DOS  
アセンブラ：Microsoft Macro assembler 6.00AD  

上記MASM6.0のほかに生成した Z80EM.EXEの  
EXEヘッダの切り離しにSYMDEBを使っています。  

ファイル構成  
Z80EM.ASM --- ソースファイル  
Z80.BAT ----- アセンブル、EXEヘッダ切り離しを一連で実行するバッチ  
Z80.PAT ----- EXEヘッダ切り離しをSYMDEBで実行するためのスクリプト  
Z80EM.LST --- MASMが生成するリスティングファイル  
Z80EM.OBJ --- MASMが生成するオブジェクトファイル  
Z80EM.EXE --- MASMが生成する実行ファイル（単体での実行は無意味）  
Z80EM.BIN --- Z80EM.EXEからEXEヘッダを切り離しOS非依存にしたモジュール  

## 使い方

x86 16bit環境で本モジュールを任意のRAM領域にロード、  
セグメントレジスタ DS には Z80コードをロードしたセグメント値を設定し  
エントリポイント(nnnn:0e0h)を FAR CALL します。  

本モジュールとZ80コードのロードに各64KB  
合計128KBの空きエリアが必要です。  

~~スタックはエントリ時のFAR CALL分以外消費しません。~~  
（2025/6/9追記）使ってます。Z80機能追加時に後で修正するつもりで  
一時的のつもり使ったのですが忘れてました。  
絶対アドレス指示で退避よりPUSH/POPの方が速そうなのでそのままにしました。  

Z80のレジスタは、以下の通りx86レジスタに対応させています、  
Z80コード実行（FAR CALL）に先立ち、各レジスタを設定しておきます。  

Z80 --- x86  
Flag -- AH  
A ----- AL  
B ----- CH  
C ----- CL  
D ----- DH  
E ----- DL  
H ----- BH  
L ----- BL  
PC ---- SI  
SP ---- DI  

裏レジスタなどはメモリに割り当てています。

BC'-- [00F0]  
DE'-- [00F2]  
HL'-- [00F4]  
AF'-- [00F6]  
IX -- [00F8]  
IY -- [00FA]  
I --- [00FC]  
R --- [00FD]  

これらのレジスタは本エミュレーションモジュールが配置された  
セグメントに置かれます。  


リターン条件  

IN、OUT、HLT、未定義命令等をフェッチするとその命令は実行せず  
その命令コードのアドレスををSIに、リターンコードをBPに  
Z80レジスタ値を対応するレジスタに保持して戻ります。  

リターンコード  
 1: HLT命令  
 2: OUT命令  
 3: IN命令  
 4: 2バイトのI/O命令, RETI, RETN  
 5: 2バイトの未定義命令  
 6: 4バイトの未定義命令  

なお、EI, DI, IM n はNOP扱いとしています。  

Rレジスタは読み込むたびに+1およびその時点のBレジスタの  
値を加算しています。  
また、LD A,R LD A,I ではフラグは変化せずIFFも未実装です。  

## ライセンス

MITライセンスとします。

## 変更履歴
2025/5/18 Rev. 1.00 初回公開
